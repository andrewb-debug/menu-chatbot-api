<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Menu Chat ‚Äî {{ restaurant_name.replace('_',' ')|replace('-',' ')|title }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Compact, widget-style look -->
  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#6b7280;
      --primary:#2563eb;
      --bot:#f1f5ff;
      --user:#e8f7ee;
      --border:#e5e7eb;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;}
    /* Widget frame: compact width/height for embedding */
    .widget{
      width: 380px;      /* tweak for your embed */
      max-width: 100%;
      height: 600px;     /* compact height */
      margin: 12px auto;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(15,23,42,.08);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Header: tiny, friendly */
    header{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-bottom:1px solid var(--border);background:#fff;
    }
    .avatar{
      width:28px;height:28px;border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #9bd0ff 0%, #2563eb 60%, #1747b7 100%);
      box-shadow: 0 2px 6px rgba(37,99,235,.25);
      flex:0 0 auto;
    }
    .title-wrap{display:flex;flex-direction:column;min-width:0}
    .title{
      font-weight:700;font-size:14.5px;line-height:1.2;margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .sub{font-size:12px;color:var(--muted);}

    /* Chat area */
    #chatBox{
      flex:1;overflow-y:auto;padding:12px;background: linear-gradient(180deg,#fafbff 0%,#ffffff 100%);
    }
    .msg{display:flex;margin:8px 0;}
    .msg.user{justify-content:flex-end;}
    .bubble{
      max-width:78%;
      padding:9px 12px;border-radius:14px;border:1px solid var(--border);
      background:var(--bot); line-height:1.45; font-size:14px;
      box-shadow: 0 2px 8px rgba(2,6,23,.04);
      white-space:pre-wrap;word-wrap:break-word;
    }
    .msg.user .bubble{
      background:var(--user); border-color:#dbece0;
    }

    /* Markdown niceties inside bot bubbles */
    .bubble p{margin:.35rem 0;}
    .bubble ul,.bubble ol{margin:.25rem 0 .25rem 1.15rem;}
    .bubble li{margin:.2rem 0;}
    .bubble strong{font-weight:700;}

    /* Input row: compact */
    .input-row{
      display:flex;gap:8px;padding:10px;border-top:1px solid var(--border);background:#fff;
    }
    .input{
      flex:1;padding:10px 12px;border:1px solid var(--border);border-radius:12px;font-size:14px;outline:none;
    }
    .btn{
      background:var(--primary);color:#fff;border:none;border-radius:12px;
      padding:10px 14px;font-weight:600;cursor:pointer;transition:transform .08s ease;
    }
    .btn:active{transform:translateY(1px);}
    .btn:disabled{opacity:.6;cursor:not-allowed;}

    /* Hint */
    .hint{padding:0 10px 10px;color:var(--muted);font-size:12px;}
  </style>

  <!-- Markdown parser for bot replies -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <div class="widget" role="region" aria-label="Menu chat widget">
    <header>
      <div class="avatar" aria-hidden="true"></div>
      <div class="title-wrap">
        <div class="title">Menu Chat ‚Äî {{ restaurant_name.replace('_',' ')|replace('-',' ')|title }}</div>
        <div class="sub">Ask about items, allergens, and prices</div>
      </div>
    </header>

    <div id="chatBox" aria-live="polite"></div>

    <div class="input-row">
      <input id="userInput" class="input" type="text" placeholder="Ask a question‚Ä¶" aria-label="Your message"/>
      <button id="sendBtn" class="btn" aria-label="Send message">Send</button>
    </div>
    <div class="hint">Tip: ‚ÄúWhat sandwiches do you have?‚Äù ‚Ä¢ ‚ÄúAllergens in Spicy Chicken Sandwich?‚Äù</div>
  </div>

  <script>
    const restaurantSlug = "{{ restaurant_name }}";
    const restaurantPretty = "{{ restaurant_name.replace('_',' ')|replace('-',' ')|title }}";
    const chatBox = document.getElementById("chatBox");
    const userInput = document.getElementById("userInput");
    const sendBtn = document.getElementById("sendBtn");

    // Initial friendly greeting (Markdown)
    appendMessage("bot",
`üëã Hi! I‚Äôm your assistant for **${restaurantPretty}**.
Ask me about menu items, allergens, prices, or dietary options.`, true);

    sendBtn.addEventListener("click", sendMessage);
    userInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") sendMessage(); });

    async function sendMessage(){
      const text = userInput.value.trim();
      if(!text) return;
      appendMessage("user", text);
      userInput.value = "";
      setLoading(true);

      try{
        const res = await fetch(`/chat?restaurant=${encodeURIComponent(restaurantSlug)}`,{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ message:text })
        });
        const data = await res.json();
        const reply = data.reply || "Sorry, I didn‚Äôt get a reply.";
        appendMessage("bot", reply, true);
      }catch(err){
        appendMessage("bot","Network error. Please try again.");
      }finally{
        setLoading(false);
      }
    }

    function setLoading(s){
      sendBtn.disabled = s;
      sendBtn.textContent = s ? "Sending‚Ä¶" : "Send";
    }

    // Render: bot messages as Markdown; user as plain text
    function appendMessage(sender, text, isMarkdown=false){
      const row = document.createElement("div");
      row.className = `msg ${sender}`;
      const bubble = document.createElement("div");
      bubble.className = "bubble";

      if(sender==="bot" && isMarkdown){
        bubble.innerHTML = marked.parse(text);
      }else{
        bubble.textContent = text;
      }
      row.appendChild(bubble);
      chatBox.appendChild(row);
      chatBox.scrollTop = chatBox.scrollHeight;
    }
  </script>
</body>
</html>